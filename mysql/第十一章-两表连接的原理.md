# 两表连接的原理

## 概念

- 驱动表
- 被驱动表

```mysql
# t1为驱动表 t2为被驱动表
SELECT * FROM t1 INNER JOIN t2;

# t1为驱动表 t2为被驱动表
SELECT * FROM t1 LEFT JOIN t2;
SELECT * FROM t1 RIGHT JOIN t2;
```

## 内连接与外连接

### 内连接

1. 对于内连接的两个表，若驱动表中的记录在被驱动表中找不到对应条件匹配的记录，则该记录不会被加入最后的结果集

### 外连接

1. 对于外连接的两个表，若驱动表中的记录在被驱动表中找不到对应条件匹配的记录，最终的结果集中也会加入该记录，其被驱动表的列字段默认为类型NULL值
2. 外连接可以细分为2种
   - **左外连接：选取左侧的表为驱动表**
   - **右外连接：选取右侧的表为驱动表**
3. 对于外连接来说，必须使用ON子句来指出连接条件

## 查询过程

> 两表连接查询中，驱动表只需要访问一次，而被驱动表可能需要访问多次，被驱动表的访问次数取决于驱动表中过滤条件后的结果集记录总数

1. 先确定好驱动表
2. 每从驱动表中获取到一条记录，都需要**立即**到被驱动表中查询与条件匹配的记录

## 连接查询原理

### 嵌套循环连接

- 步骤
  - 选取驱动表，使用只涉及驱动表的过滤条件，选取代价成本最低的单表访问方法来筛选驱动表的结果集
  - 对驱动表的结果集中的每条记录都分别到被驱动表中查找与之匹配的记录
  - 被驱动表的访问次数取决于驱动表中过滤条件后的结果集记录总数

### 使用索引加快被驱动表查询速度

- 查询被驱动表也相当于一次单表查询，可以使用索引来加快查询速度

### 基于块的嵌套循环连接

1. 嵌套循环连接中，每次从驱动表中取出一条记录时，都需要将被驱动表按页从磁盘移动到内存中，若内存满了还需要将已移动到内存的数据重新移动到磁盘中，再进行SWAP，因此这一举动对数据量较大的被驱动表来说非常消耗IO成本
2. 因此我们可以**将驱动表中筛选出的结果集放置在一块内存区域中**，被驱动表移动到内存中的页面中的每条记录都与这一块内存中的所有驱动表记录进行匹配，这样可以显著的减少被驱动表的IO成本
3. 这块内存叫做**JOIN BUFFER(连接缓冲区)**，在执行连接查询前申请的一块固定大小的内存，大小可以通过MySql的系统变量**join_buffer_size**进行配置
4. Join Buffer只会保存驱动表记录相关匹配条件的列