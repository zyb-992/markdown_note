# 进程

# 什么是进程

1. 进程的基本元素

   1. 程序代码：可能被执行相同程序的其他进程共享
   2. 与代码相关联的**数据集**

2. **进程控制块**：由操作系统创建和管理 在进程进入阻塞或就绪态时 可以保存进程上下文信息 以便下次恢复原样

3. 进程状态

   1. 五状态模型

      1. **新建态** 通常是进程控制块已经创建但还未加载到内存中的新进程

      2. **就绪态** 进程做好准备 加入到操作系统的就绪队列中等待执行

      3. **运行态** 进程正在执行

      4. **阻塞态** 进程在某些事件发生前不能执行 等待事件发生前就处于阻塞态

      5. **退出态** 操作系统从可执行进程组中释放出来 要么是进程自身停止 要么因某种原因被取消

         ![image-20220808193347299](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808193347299.png)

         ​				运行->就绪：进程执行满了CPU给予的时间片

         ​				运行->阻塞：由于进程需要等待某些事件发生

         ![			](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808194149605.png) 

   2. **被挂起的进程**

      1. **交换 ：把内存中的某个进程的一部分或全部移动到磁盘中 当内存中不存在就绪态的进程时 操作系统就把被阻塞的进程换出到磁盘中的挂起队列 即临时从内存中踢出的进程的队列 此后操作系统要么从挂起队列中取出另一个进程 要么接收一个新进程的请求 将其放入内存运行**
      2. 含有挂起态的进程状态转换
         1. **新建态** 通常是进程控制块已经创建但还未加载到内存中的新进程
         2. **就绪态** 进程做好准备 加入到操作系统的就绪队列中等待执行
         3. **运行态** 进程正在执行
         4. **阻塞态** 进程在某些事件发生前不能执行 等待事件发生前就处于阻塞态
         5. **退出态** 操作系统从可执行进程组中释放出来 要么是进程自身停止 要么因某种原因被取消
         6. **就绪/挂起态** 进程在外存中(虚拟内存)并准备就绪 只要载入内存就可以执行
         7. **阻塞/挂起态** 进程在外存中并等待一个事件的发生

      ![image-20220808194522592](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808194522592.png)

      ​			阻塞态 -> 阻塞/挂起态 ：操作系统需要确定当前正在运行的进程 或就绪进程为了维护基本的性能而需要更多的内存空间 就把在内存中正在阻塞的进程**交换**到外存中 进程状态成为阻塞/挂起态

      ​			阻塞/挂起态 -> 就绪/挂起态 ：挂起的进程等待的某一事件发生了 即可切换到该状态

      ​			就绪 -> 就绪/挂起态  ：操作系统确定了高优先级的阻塞态进程很快就会就绪 那么可能会选择挂起一个低优先级的就绪态进程 而非一个高优先级的阻塞态进程(调度)

# 进程描述

1. 要控制进程并管理资源 操作系统需要一些信息

2. 操作系统的控制结构

   1. **内存表** 用于跟踪内存和外存（虚拟内存）

      1. 包含信息

      ![image-20220808195742465](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808195742465.png)

   2. **IO表** 管理计算机系统中的IO设备和通道 通过该表操作系统得知IO操作的状态 以及作为IO传送的源与目标的内存单元

   3. **文件表** 提供关于文件是否存在、文件在外存中的位置 当前状态和其他属性的信息

   4. **进程表** 

   ![image-20220808195627397](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808195627397.png)

3. 进程控制结构

   > 操作系统在管理和控制进程时 首先要知道进程位置 其次要知道进程属性

   1. **进程位置**： 程序、数据、栈、属性的集合称为**进程映像**
      1. 进程映像通常保存在相邻的内存块中或连续的内存块中

   ![image-20220808200308129](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808200308129.png)

   2. **进程属性**：

      1. **进程控制块PCB**分为三类信息

         1. 进程表示信息
         2. 进程状态信息
         3. 进程控制信息

      2. **处理器状态信息**：由处理器寄存器的内容组成 运行进程时 进程的信息一定会出现在寄存器中 中断进程时 要保存该进程的所有信息 所有处理器设计都包括一个或一组寄存器**程序状态字PSW** 包含有处理器的状态信息

         ![image-20220808210324871](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808210324871.png)

      3. **进程控制信息** ：操作系统控制和协调各种活动进程所需的额外信息

![image-20220808205858440](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808205858440.png)

3. 进程映像在虚存中的结构
   1. **每个进程映像都由进程控制块、用户栈、进程专用地址空间以及与其他进程共享的其他地址空间组成**

![image-20220808210454511](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808210454511.png)

# 进程控制

1. 执行模式

   1. 用户模式

      1. 不能拥有内核模式所拥有的部分指令集

   2. 内核模式

      ![image-20220808210718205](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808210718205.png)

      3. 如何切换？

         1. 包含一个2位CPL(当前特权级别)的处理器状态寄存器**PSR** 级别3为最低 级别0为最高 即内核

         2. 发生中断时 处理器会清空PSR的CPL字段 自动将其设置为0 即陷入内核模式执行 中断结束末尾指令是**IRT** 使处理器恢复源程序的特权级别

            

2. 进程创建

   1. 操作系统创建新进程的操作
      1. 为新进程分配一个唯一的进程标识符 ：主进程表中会添加一个表项
      2. 为进程分配空间 ：包括进程映像的所有元素
      3. 初始化进程控制块 
      4. 设置正确的链接 : 操作系统将每个调度队列都维护为一个链表 新进程必须放在就绪或就绪/挂起链表中
      5. 创建或扩充其他数据结构

3. 进程切换

   1. 某个时刻 操作系统中断一个正在运行的进程 将另一个进程置于运行模式 并把CPU的控制权交给新运行的进程

   2. **何时切换进程**

      1. 系统中断

         1. **中断** ：与当前正运行进程无关的某种外部事件相关(如完成一次IO操作) 

         ![image-20220808211948876](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808211948876.png)

         1. **陷阱** ：与当前正运行进程产生的错误或异常条件相关 如计算结果溢出 菲方的文件访问

            对于陷进 操作系统确定错误或异常条件是否致命 根据这个判断是否退出该进程

         ![image-20220808211720903](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808211720903.png)

   3. 模式切换 

      1. 中断时 用户模式切换到内核模式 此时要将已中断进程的上下文保存到该进程的进程控制块中 上下文数据包含中断处理程序可能改变的所有信息 以及恢复被中断程序所需要的所有信息
      2. 中断发生后CPU并不一定调度然后切换到另一个程序执行 可能执行完中断处理程序后 继续执行正在运行的进程 这时要做的工作是中断结束后 在控制权返回该程序时恢复上下文信息

   4. **进程状态的变化**

      1. **模式切换与进程切换是不同的 模式切换可在不改变运行态进程的状态的情况下出现 此时保存上下文并恢复原装只需要CPU很小的开销 而切换进程状态则开销会比模式切换大很多**

      ![image-20220808213506517](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808213506517.png)![image-20220808213526879](C:\Users\zyb\AppData\Roaming\Typora\typora-user-images\image-20220808213526879.png)

​					

